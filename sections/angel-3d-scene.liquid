{% schema %}
{
  "name": "Angel 3D Scene Real",
  "settings": [
    {
      "type": "header",
      "content": "Model Settings"
    },
    {
      "type": "text",
      "id": "model_url",
      "label": "3D Model URL (.glb)",
      "info": "Upload your .glb file to Shopify Files and paste the URL here. If empty, a placeholder cube will be shown."
    },
    {
      "type": "range",
      "id": "model_scale",
      "min": 0.1,
      "max": 10,
      "step": 0.1,
      "label": "Model Scale",
      "default": 1
    },
    {
      "type": "header",
      "content": "Scene Appearance"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#050505"
    },
    {
      "type": "color",
      "id": "light_color",
      "label": "Light Color",
      "default": "#fab320"
    },
    {
      "type": "range",
      "id": "bloom_strength",
      "min": 0,
      "max": 3,
      "step": 0.1,
      "label": "Glow/Bloom Strength",
      "default": 1.5
    }
  ],
  "presets": [
    {
      "name": "Angel 3D Scene Real"
    }
  ]
}
{% endschema %}

<!-- 3D Canvas Container -->
<div id="angel-3d-container"></div>

<!-- Scrollable Content Layer -->
<div class="angel-scroll-content">
  
  <!-- Section 1: Hero -->
  <section class="scroll-section" id="section-hero">
    <div class="content-block center">
      <h1 class="main-title tracking-in-expand">ANGEL COLLECTION</h1>
      <p class="subtitle fade-in-up delay-1">The Divine Arrival</p>
      <div class="scroll-indicator fade-in-up delay-2">
        <span>SCROLL TO ASCEND</span>
        <div class="line"></div>
      </div>
    </div>
  </section>

  <!-- Section 2: Narrative - The Guardian -->
  <section class="scroll-section" id="section-story-1">
    <div class="content-block left">
      <h2 class="section-title">THE GUARDIAN</h2>
      <p class="text-body">
        Forged in silence.<br>
        A symbol of protection in a chaotic world.<br>
        The angel watches over those who dare to stand apart.
      </p>
    </div>
  </section>

  <!-- Section 3: Visual Break -->
  <section class="scroll-section" id="section-visual"></section>

  <!-- Section 4: Narrative - The Fallen -->
  <section class="scroll-section" id="section-story-2">
    <div class="content-block right">
      <h2 class="section-title">THE FALLEN</h2>
      <p class="text-body">
        Not all angels belong to the sky.<br>
        Some find their strength in the shadows.<br>
        Embrace your dark side.
      </p>
    </div>
  </section>

  <!-- Section 5: Collection Showcase / CTA -->
  <section class="scroll-section" id="section-cta">
    <div class="content-block center">
      <h2 class="section-title">OWN THE LEGEND</h2>
      <a href="/collections/all" class="cta-button">EXPLORE COLLECTION</a>
    </div>
  </section>

</div>

<!-- Loading Screen -->
<div id="loading-screen">
  <div class="loader-content">
    <div class="loader-text">SUMMONING ANGEL...</div>
    <div class="loader-bar"><div class="loader-progress"></div></div>
  </div>
</div>

<style>
  /* Reset & Layout */
  body, html {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    background-color: {{ section.settings.bg_color }};
    font-family: 'Futura', 'Helvetica Neue', Arial, sans-serif;
  }
  
  /* Hide Header/Footer initially restored, can be toggled via CSS if needed 
     For now we keep them VISIBLE as requested */

  /* 3D Container */
  #angel-3d-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 1;
    pointer-events: none;
  }

  /* Content Layer */
  .angel-scroll-content {
    position: relative;
    z-index: 2;
    width: 100%;
  }

  /* Scroll Sections */
  .scroll-section {
    height: 100vh;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  /* Content Blocks */
  .content-block {
    max-width: 600px;
    padding: 40px;
    color: #fff;
    opacity: 0;
    transform: translateY(30px);
    transition: all 1s ease-out;
  }
  
  .content-block.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .content-block.center { text-align: center; }
  .content-block.left { margin-right: auto; margin-left: 10%; text-align: left; }
  .content-block.right { margin-left: auto; margin-right: 10%; text-align: right; }

  /* Typography */
  .main-title {
    font-size: 5rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    margin-bottom: 20px;
    line-height: 1.1;
  }
  
  .subtitle {
    font-size: 1.2rem;
    letter-spacing: 0.1em;
    color: #888;
    text-transform: uppercase;
  }

  .section-title {
    font-size: 3rem;
    font-weight: 600;
    letter-spacing: 0.15em;
    margin-bottom: 20px;
    color: #fff;
    border-bottom: 2px solid {{ section.settings.light_color }};
    display: inline-block;
    padding-bottom: 10px;
  }

  .text-body {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #ccc;
    margin-bottom: 30px;
  }

  /* CTA Button */
  .cta-button {
    display: inline-block;
    padding: 15px 40px;
    border: 1px solid {{ section.settings.light_color }};
    color: {{ section.settings.light_color }};
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 2px;
    font-weight: bold;
    transition: all 0.3s;
    background: transparent;
    cursor: pointer;
    pointer-events: auto;
  }
  
  .cta-button:hover {
    background: {{ section.settings.light_color }};
    color: #000;
    box-shadow: 0 0 20px {{ section.settings.light_color }};
  }

  /* Scroll Indicator */
  .scroll-indicator {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    font-size: 0.8rem;
    letter-spacing: 3px;
    color: #666;
  }
  
  .scroll-indicator .line {
    width: 1px;
    height: 60px;
    background: linear-gradient(to bottom, #666, transparent);
  }

  /* Loader */
  #loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 1s ease;
  }
  
  .loader-text {
    color: {{ section.settings.light_color }};
    letter-spacing: 2px;
    margin-bottom: 10px;
    font-family: monospace;
  }
  
  .loader-bar {
    width: 200px;
    height: 2px;
    background: #333;
    position: relative;
    overflow: hidden;
  }
  
  .loader-progress {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0%;
    background: {{ section.settings.light_color }};
    transition: width 0.2s;
  }

  /* Mobile Adjustments */
  @media (max-width: 768px) {
    .main-title { font-size: 3rem; }
    .section-title { font-size: 2rem; }
    .content-block.left, .content-block.right { 
      margin: 0 auto; 
      text-align: center;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }
  }
</style>

<!-- THREE.JS IMPORTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
<!-- Post Processing -->
<script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // CONFIGURATION
    const CONFIG = {
      modelUrl: "{{ section.settings.model_url }}",
      modelScale: {{ section.settings.model_scale }},
      bgColor: {{ section.settings.bg_color | json }},
      lightColor: {{ section.settings.light_color | json }},
      bloomStrength: {{ section.settings.bloom_strength }}
    };

    // SETUP SCENE
    const container = document.getElementById('angel-3d-container');
    const loadingBar = document.querySelector('.loader-progress');
    const loadingScreen = document.getElementById('loading-screen');
    
    // Create Scene with matching background
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(CONFIG.bgColor);
    scene.fog = new THREE.FogExp2(CONFIG.bgColor, 0.0035);

    // Camera
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 8);

    // Renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.toneMapping = THREE.ReinhardToneMapping;
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    // Lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    
    const spotLight = new THREE.SpotLight(CONFIG.lightColor, 2);
    spotLight.position.set(5, 10, 5);
    spotLight.castShadow = true;
    scene.add(spotLight);
    
    const backLight = new THREE.PointLight(0x0044ff, 1.5);
    backLight.position.set(-5, 0, -5);
    scene.add(backLight);

    // Post Processing
    const renderScene = new THREE.RenderPass(scene, camera);
    const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    bloomPass.threshold = 0.1;
    bloomPass.strength = CONFIG.bloomStrength;
    bloomPass.radius = 0.5;

    const composer = new THREE.EffectComposer(renderer);
    composer.addPass(renderScene);
    composer.addPass(bloomPass);

    // LOAD MODEL
    const loader = new THREE.GLTFLoader();
    
    // Optional: Setup Draco if your models are compressed
    const dracoLoader = new THREE.DRACOLoader();
    dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
    loader.setDRACOLoader(dracoLoader);

    let angelModel = null;
    let mixer = null;
    let clock = new THREE.Clock();

    function onModelLoaded(gltf) {
      angelModel = gltf.scene;
      angelModel.scale.set(CONFIG.modelScale, CONFIG.modelScale, CONFIG.modelScale);
      
      // Center the model roughly
      const box = new THREE.Box3().setFromObject(angelModel);
      const center = box.getCenter(new THREE.Vector3());
      angelModel.position.x += (angelModel.position.x - center.x);
      angelModel.position.y += (angelModel.position.y - center.y);
      angelModel.position.z += (angelModel.position.z - center.z);
      
      // Shadow setup
      angelModel.traverse((node) => {
        if (node.isMesh) {
          node.castShadow = true;
          node.receiveShadow = true;
          // Add emissive material if texturing isn't strong enough
          if (node.material) {
             node.material.envMapIntensity = 1;
          }
        }
      });

      scene.add(angelModel);

      // Animation Mixer
      if (gltf.animations && gltf.animations.length > 0) {
        mixer = new THREE.AnimationMixer(angelModel);
        // Play all animations or the first one
        const action = mixer.clipAction(gltf.animations[0]);
        action.play();
      }

      hideLoader();
    }

    if (CONFIG.modelUrl && CONFIG.modelUrl !== "") {
      loader.load(
        CONFIG.modelUrl,
        onModelLoaded,
        (xhr) => {
           // Progress
           const percent = (xhr.loaded / xhr.total) * 100;
           loadingBar.style.width = percent + '%';
        },
        (error) => {
           console.error('An error happened', error);
           createPlaceholder();
           hideLoader();
        }
      );
    } else {
      console.log('No model URL provided, using placeholder.');
      createPlaceholder();
      hideLoader();
    }

    function createPlaceholder() {
      // Fallback Cube/Placeholder if no model
      const geometry = new THREE.IcosahedronGeometry(1, 1);
      const material = new THREE.MeshStandardMaterial({ 
        color: CONFIG.lightColor, 
        wireframe: true,
        emissive: 0x222222
      });
      angelModel = new THREE.Mesh(geometry, material);
      scene.add(angelModel);
    }

    function hideLoader() {
      loadingScreen.style.opacity = 0;
      setTimeout(() => { loadingScreen.style.display = 'none'; }, 1000);
    }

    // SCROLL ANIMATION VARS
    let scrollProgress = 0;
    
    window.addEventListener('scroll', () => {
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      scrollProgress = Math.max(0, Math.min(1, window.scrollY / docHeight));
      
      // Reveal text
      document.querySelectorAll('.content-block').forEach((block) => {
        const rect = block.getBoundingClientRect();
        if (rect.top < window.innerHeight * 0.75 && rect.bottom > 0) {
          block.classList.add('visible');
        }
      });
    });

    // RENDER LOOP
    function animate() {
      requestAnimationFrame(animate);
      
      const delta = clock.getDelta();
      if (mixer) mixer.update(delta);

      if (angelModel) {
        // Idle Motion
        if (!mixer) {
              angelModel.rotation.y += 0.005;
             angelModel.position.y += Math.sin(clock.getElapsedTime()) * 0.002;
        }

        // SCROLL PATH LOGIC
        // Map 0 -> 1 scroll to position curve
        // Start: Center (0,0,0)
        // Mid: Left (-2, 0, 0)
        // End: Up/Center (0, 2, 2)
        
        const t = scrollProgress;
        
        // Simple interpolation
        if (t < 0.5) {
          // 0 to 0.5: Move Left & Rotate
          const phase = t * 2; // 0 to 1
          angelModel.position.x = THREE.MathUtils.lerp(0, 2, phase);
          angelModel.rotation.y = THREE.MathUtils.lerp(0, -0.5, phase) + (mixer ? 0 : clock.getElapsedTime()*0.5);
        } else {
          // 0.5 to 1: Move Right -> Center -> Up
          const phase = (t - 0.5) * 2; // 0 to 1
          angelModel.position.x = THREE.MathUtils.lerp(2, 0, phase);
          angelModel.position.y = THREE.MathUtils.lerp(0, 2, phase);
          angelModel.position.z = THREE.MathUtils.lerp(0, 3, phase);
          angelModel.rotation.x = THREE.MathUtils.lerp(0, 0.2, phase);
        }
        
        // Camera also moves slightly
        camera.position.y = t * 1;
      }

      composer.render();
    }

    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      composer.setSize(window.innerWidth, window.innerHeight);
    });
  });
</script>

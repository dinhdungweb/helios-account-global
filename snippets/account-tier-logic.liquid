{% comment %}
  Snippet: Account Tier Logic
  Usage: {% render 'account-tier-logic' %}
  Outputs:
    - total_spent
    - points
    - tier
    - next_tier
    - next_tier_amount
    - progress_percentage
    - remaining_amount
{% endcomment %}

{% comment %} Calculate total spent (Directly from Shopify) {% endcomment %}
{% assign total_spent = customer.total_spent | divided_by: 100 %}

{% assign points = customer.metafields.rewards.points | default: 0 %}

{% comment %} Check customer tags first (Overrides calculated tier) {% endcomment %}
{% if customer.tags contains "BLACK DIAMOND" %}
  {% assign tier = "BLACK DIAMOND" %}
  {% assign next_tier = "MAX LEVEL" %}
  {% assign next_tier_amount = total_spent %}
{% elsif customer.tags contains "DIAMOND" %}
  {% assign tier = "DIAMOND" %}
  {% assign next_tier = "BLACK DIAMOND" %}
  {% assign next_tier_amount = 10000 %}
{% elsif customer.tags contains "PLATINUM" %}
  {% assign tier = "PLATINUM" %}
  {% assign next_tier = "DIAMOND" %}
  {% assign next_tier_amount = 5000 %}
{% elsif customer.tags contains "GOLD" %}
  {% assign tier = "GOLD" %}
  {% assign next_tier = "PLATINUM" %}
  {% assign next_tier_amount = 2000 %}
{% elsif customer.tags contains "SILVER" %}
  {% assign tier = "SILVER" %}
  {% assign next_tier = "GOLD" %}
  {% assign next_tier_amount = 500 %}
{% else %}

  {% comment %} If no tag, determine tier by total spent {% endcomment %}
  {% if total_spent < 250 %}
    {% assign tier = "MEMBER" %}
    {% assign next_tier = "SILVER" %}
    {% assign next_tier_amount = 250 %}
  {% elsif total_spent >= 250 and total_spent < 500 %}
    {% assign tier = "SILVER" %}
    {% assign next_tier = "GOLD" %}
    {% assign next_tier_amount = 500 %}
  {% elsif total_spent >= 500 and total_spent < 2000 %}
    {% assign tier = "GOLD" %}
    {% assign next_tier = "PLATINUM" %}
    {% assign next_tier_amount = 2000 %}
  {% elsif total_spent >= 2000 and total_spent < 5000 %}
    {% assign tier = "PLATINUM" %}
    {% assign next_tier = "DIAMOND" %}
    {% assign next_tier_amount = 5000 %}
  {% elsif total_spent >= 5000 and total_spent < 10000 %}
    {% assign tier = "DIAMOND" %}
    {% assign next_tier = "BLACK DIAMOND" %}
    {% assign next_tier_amount = 10000 %}
  {% else %}
    {% assign tier = "BLACK DIAMOND" %}
    {% assign next_tier = "MAX LEVEL" %}
    {% assign next_tier_amount = total_spent %}
  {% endif %}
{% endif %}

{% comment %} Calculate progress percentage {% endcomment %}
{% if tier == "BLACK DIAMOND" %}
  {% assign progress_percentage = 100 %}
  {% assign remaining_amount = 0 %}
{% else %}
  {% assign progress_percentage = total_spent | times: 100 | divided_by: next_tier_amount %}
  {% assign remaining_amount = next_tier_amount | minus: total_spent %}
{% endif %}

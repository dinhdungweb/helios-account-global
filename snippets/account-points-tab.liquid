{% comment %}
  Snippet: Account Points Tab Content
  Tích hợp đổi điểm vào trang Account - Style V2 (Industrial Minimalist)
{% endcomment %}

{% comment %} Cấu hình API URL - Thay đổi theo URL Vercel của bạn {% endcomment %}
{% assign rewards_api_url = 'https://helios-tier-pricing-api-h543.vercel.app' %}

<div class="points-exchange-wrapper">
  <div class="points-two-columns">
    
    {% comment %}--- LEFT COLUMN: EXCHANGE ---{% endcomment %}
    <div class="points-column points-column-left">
      
      {% comment %}--- POINTS BALANCE ---{% endcomment %}
      <div class="points-hero">
        <div class="points-hero-inner">
          <div class="points-stat">
            <span class="points-stat-label">Current Rewards Points</span>
            <span class="points-stat-value" id="currentPointsDisplay" data-points="{{ points | default: 0 }}">{{ points | default: 0 }}</span>
          </div>
          <div class="points-stat">
            <span class="points-stat-label">Exchange Rate</span>
            <span class="points-stat-info">1,000 points = $10</span>
          </div>
        </div>
      </div>

      {% if points >= 5000 %}
      {% comment %}--- EXCHANGE FORM ---{% endcomment %}
      <div class="points-exchange-section">
        <form id="account-reward-exchange-form">
          <input type="hidden" id="acc-customerId" value="{{ customer.id }}">
          
          <div class="exchange-grid">
            <label class="exchange-card">
              <input type="radio" name="discount_value" value="50" checked>
              <div class="exchange-card-inner">
                <span class="card-amount">$50</span>
                <span class="card-points">5,000 points</span>
              </div>
            </label>
            
            <label class="exchange-card">
              <input type="radio" name="discount_value" value="100">
              <div class="exchange-card-inner">
                <span class="card-amount">$100</span>
                <span class="card-points">10,000 points</span>
              </div>
            </label>
            
            <label class="exchange-card {% if points < 20000 %}is-locked{% endif %}">
              <input type="radio" name="discount_value" value="200" {% if points < 20000 %}disabled{% endif %}>
              <div class="exchange-card-inner">
                <span class="card-amount">$200</span>
                <span class="card-points">20,000 points</span>
              </div>
            </label>
            
            <label class="exchange-card {% if points < 50000 %}is-locked{% endif %}">
              <input type="radio" name="discount_value" value="500" {% if points < 50000 %}disabled{% endif %}>
              <div class="exchange-card-inner">
                <span class="card-amount">$500</span>
                <span class="card-points">50,000 points</span>
              </div>
            </label>
          </div>
          
          <button type="submit" class="dashboard-btn exchange-submit-btn" id="acc-exchange-btn">
            <span class="btn-text">Redeem Now</span>
            <span class="btn-loading" style="display:none;">
              <span class="loading-spinner"></span>
            </span>
          </button>
        </form>
      </div>
      {% else %}
      {% comment %}--- NOT ENOUGH POINTS ---{% endcomment %}
      <div class="points-insufficient-box">
        <div class="insufficient-icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <p>You need at least <strong>5,000 points</strong> to redeem a discount code.</p>
        <p class="current-points">Current points: <strong>{{ points }}</strong></p>
      </div>
      {% endif %}
      
    </div>

    {% comment %}--- RIGHT COLUMN: HISTORY ---{% endcomment %}
    <div class="points-column points-column-right">
      <div class="points-history-section">
        <h4 class="section-title">Redemption History</h4>
        <div class="table-responsive">
          <table class="dashboard-table" id="acc-reward-history">
            <thead>
              <tr>
                <th>Date</th>
                <th>Points</th>
                <th>Discount Code</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="loading-cell">No redemption history</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
  </div>
</div>

{% comment %}--- RESULT MODAL ---{% endcomment %}
<div class="points-modal-overlay" id="pointsModalOverlay">
  <div class="points-modal">
    <button class="modal-close" id="modalCloseBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <h3 class="modal-title" id="modalTitle"></h3>
    <div class="modal-body" id="modalBody"></div>
    <button class="dashboard-btn modal-action-btn" id="modalActionBtn">Close</button>
  </div>
</div>

<style>
.points-exchange-wrapper {
  max-width: 100%;
}

.points-two-columns {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 30px;
  align-items: stretch;
}

.points-column {
  display: flex;
  flex-direction: column;
}

.points-column-right {
  max-height: 500px;
  display: flex;
  flex-direction: column;
}

.hero-content {
  max-width: 1400px;
}

.points-column-left {
  min-width: 400px;
}

/* Custom Scrollbar */
.table-responsive::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

.table-responsive::-webkit-scrollbar-track {
  background: var(--helios-dark-grey);
}

.table-responsive::-webkit-scrollbar-thumb {
  background: var(--helios-border);
  border-radius: 3px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
  background: var(--helios-orange);
}

.points-hero {
  background: rgba(255,255,255,0.02);
  border: 1px solid var(--helios-border);
  padding: 30px;
  margin-bottom: 30px;
}

.points-hero-inner {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 30px;
}

.points-stat {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.points-stat-label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--helios-text-muted);
}

.points-stat-value {
  font-size: 42px;
  font-weight: 700;
  color: var(--helios-orange);
  line-height: 1;
}

.points-stat-info {
  font-size: 14px;
  color: #ccc;
}

.points-exchange-section {
  margin-bottom: 40px;
}

.exchange-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  margin-bottom: 25px;
}

.exchange-card {
  position: relative;
  cursor: pointer;
  margin: 0;
}

.exchange-card input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.exchange-card-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 25px 15px;
  background: var(--helios-dark-grey);
  border: 1px solid var(--helios-border);
  transition: all 0.3s;
  min-height: 120px;
  position: relative;
}

.exchange-card:hover .exchange-card-inner {
  border-color: var(--helios-orange);
}

.exchange-card input:checked + .exchange-card-inner {
  border-color: var(--helios-orange);
  background: rgba(250, 179, 32, 0.08);
}

.exchange-card input:checked + .exchange-card-inner::before {
  content: '';
  position: absolute;
  top: 10px;
  right: 10px;
  width: 20px;
  height: 20px;
  background: var(--helios-orange);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23000' stroke-width='3'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: center;
}

.exchange-card.is-locked {
  opacity: 0.4;
  pointer-events: none;
}

.exchange-card.is-locked .exchange-card-inner::after {
  content: '';
  position: absolute;
  top: 10px;
  right: 10px;
  width: 16px;
  height: 16px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'%3E%3C/rect%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: center;
}

.card-amount {
  font-size: 22px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 12px;
}

.card-points {
  font-size: 13px;
  color: var(--helios-orange);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.card-tag {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--helios-orange);
  color: #000;
  font-size: 10px;
  font-weight: 700;
  text-align: center;
  padding: 3px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Exchange Button */
.exchange-submit-btn {
  width: 100%;
  padding: 18px 30px;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.loading-spinner {
  display: inline-block;
  width: 18px;
  height: 18px;
  border: 2px solid #000;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Insufficient Points */
.points-insufficient-box {
  background: rgba(255, 179, 0, 0.05);
  border: 1px solid var(--helios-border);
  padding: 40px;
  text-align: center;
}

.insufficient-icon {
  margin-bottom: 15px;
  color: var(--helios-orange);
  opacity: 0.7;
}

.points-insufficient-box p {
  margin: 8px 0;
  color: #ccc;
}

.points-insufficient-box strong {
  color: var(--helios-orange);
}

/* History Section */
.points-history-section {
  background: var(--helios-dark-grey);
  border: 1px solid var(--helios-border);
  padding: 0;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.points-column-right .points-history-section {
  margin-top: 0;
}

.section-title {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #fff;
  margin: 0;
  padding: 20px 25px;
  background: rgba(255,255,255,0.02);
  border-bottom: 1px solid var(--helios-border);
  border-left: 4px solid var(--helios-orange);
}

.table-responsive {
  overflow-x: auto;
  overflow-y: auto;
  flex: 1;
}

#acc-reward-history {
  width: 100%;
  border-collapse: collapse;
}

#acc-reward-history th {
  text-align: left;
  padding: 15px 20px;
  color: var(--helios-text-muted);
  text-transform: uppercase;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.5px;
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid var(--helios-border);
  white-space: nowrap;
}

#acc-reward-history td {
  padding: 15px 20px;
  border-bottom: 1px solid var(--helios-border);
  color: #ccc;
  font-size: 14px;
}

#acc-reward-history tbody tr:nth-child(even) {
  background: rgba(255,255,255,0.02);
}

#acc-reward-history tbody tr:hover {
  background: rgba(250, 179, 32, 0.05);
}

#acc-reward-history tbody tr:last-child td {
  border-bottom: none;
}

#acc-reward-history td:last-child {
  color: var(--helios-orange);
  font-weight: 600;
}

{% comment %} #acc-reward-history td:nth-child(2) {
  color: #ff6b6b;
  font-weight: 500;
} {% endcomment %}

.loading-cell,
.empty-cell {
  text-align: center;
  color: var(--helios-text-muted);
  font-style: italic;
  padding: 40px 20px !important;
  background: transparent !important;
}

#acc-reward-history code {
  display: inline-block;
  background: var(--helios-orange);
  color: #000;
  padding: 4px 10px;
  font-weight: 700;
  font-size: 11px;
  letter-spacing: 0.5px;
}

@media (max-width: 600px) {
  #acc-reward-history thead {
    display: none;
  }
  
  #acc-reward-history tbody tr {
    display: block;
    padding: 15px 20px;
    border-bottom: 1px solid var(--helios-border);
    background: transparent;
  }
  
  #acc-reward-history tbody tr:nth-child(even) {
    background: rgba(255,255,255,0.02);
  }
  
  #acc-reward-history td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border: none;
  }
  
  #acc-reward-history td::before {
    content: attr(data-label);
    font-size: 11px;
    text-transform: uppercase;
    color: var(--helios-text-muted);
    font-weight: 600;
  }
}

/* Modal Styles */
.points-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
}

.points-modal-overlay.is-visible {
  display: flex;
}

.points-modal {
  background: var(--helios-dark-grey);
  border: 1px solid var(--helios-border);
  max-width: 420px;
  width: 100%;
  padding: 40px;
  position: relative;
  text-align: center;
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  color: var(--helios-text-muted);
  cursor: pointer;
  padding: 5px;
  transition: color 0.3s;
}

.modal-close:hover {
  color: #fff;
}

.modal-icon {
  margin-bottom: 20px;
}

.modal-icon svg {
  width: 60px;
  height: 60px;
}

.modal-icon.success svg {
  color: #4CAF50;
}

.modal-icon.error svg {
  color: #f44336;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin: 0 0 15px;
  color: #fff;
}

.modal-body {
  color: #ccc;
  line-height: 1.6;
  margin-bottom: 25px;
}

.modal-body .discount-code {
  display: inline-block;
  background: var(--helios-orange);
  color: #000;
  font-weight: 700;
  font-size: 18px;
  padding: 10px 20px;
  margin: 15px 0;
  letter-spacing: 1px;
}

.modal-body .detail-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--helios-border);
}

.modal-body .detail-row:last-child {
  border-bottom: none;
}

.modal-body .detail-label {
  color: var(--helios-text-muted);
}

.modal-body .detail-value {
  color: #fff;
  font-weight: 500;
}

.modal-action-btn {
  min-width: 150px;
}

/* Responsive */
@media (min-width: 1024px) {
  .exchange-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 1023px) {
  .points-two-columns {
    grid-template-columns: 1fr;
  }
  
  .exchange-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

@media (max-width: 768px) {
  .exchange-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .points-hero-inner {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .points-stat-value {
    font-size: 32px;
  }
  
  .card-amount {
    font-size: 18px;
  }
  
  .exchange-card-inner {
    min-height: 100px;
    padding: 40px 10px;
  }
  
  .points-modal {
    padding: 30px 20px;
  }
}

@media (max-width: 480px) {
  .exchange-grid {
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
}
</style>

<script>
(function() {
  const API_URL = '{{ rewards_api_url }}';
  const customerId = document.getElementById('acc-customerId')?.value;
  
  // Format number with dot separator (Vietnamese style)
  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }
  
  // Format points display on load
  const pointsDisplay = document.getElementById('currentPointsDisplay');
  if (pointsDisplay) {
    const rawPoints = parseInt(pointsDisplay.dataset.points) || 0;
    pointsDisplay.textContent = formatNumber(rawPoints);
  }
  
  // Modal elements
  const modalOverlay = document.getElementById('pointsModalOverlay');
  const modalIcon = document.getElementById('modalIcon');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const modalActionBtn = document.getElementById('modalActionBtn');
  
  // Show modal
  function showModal(type, title, bodyHtml) {
    modalTitle.textContent = title;
    modalBody.innerHTML = bodyHtml;
    modalOverlay.classList.add('is-visible');
  }
  
  // Hide modal
  function hideModal() {
    modalOverlay.classList.remove('is-visible');
  }
  
  modalCloseBtn?.addEventListener('click', hideModal);
  modalActionBtn?.addEventListener('click', hideModal);
  modalOverlay?.addEventListener('click', function(e) {
    if (e.target === modalOverlay) hideModal();
  });
  
  // Handle exchange form
  const form = document.getElementById('account-reward-exchange-form');
  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('acc-exchange-btn');
      const btnText = btn.querySelector('.btn-text');
      const btnLoading = btn.querySelector('.btn-loading');
      
      const discountValue = form.querySelector('input[name="discount_value"]:checked')?.value;
      if (!discountValue) {
        showModal('error', 'Error', '<p>Please select a reward tier!</p>');
        return;
      }
      
      // Show loading
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline-flex';
      btn.disabled = true;
      
      try {
        const response = await fetch(`${API_URL}/api/rewards/exchange`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customer_id: customerId,
            discount_value: parseInt(discountValue)
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          const successHtml = `
            <p>You have successfully redeemed points!</p>
            <div class="discount-code">${data.discount_code}</div>
            <div class="detail-row">
              <span class="detail-label">Value</span>
              <span class="detail-value">$${parseInt(discountValue).toLocaleString()}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Points used</span>
              <span class="detail-value">${data.points_used.toLocaleString()}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Points remaining</span>
              <span class="detail-value">${formatNumber(data.remaining_points)}</span>
            </div>
          `;
          showModal('success', 'Redemption Successful', successHtml);
          // Update points in tab
          document.getElementById('currentPointsDisplay').textContent = formatNumber(data.remaining_points);
          // Update points in hero section
          const heroPoints = document.getElementById('heroPointsDisplay');
          if (heroPoints) heroPoints.textContent = formatNumber(data.remaining_points);
          loadHistory();
        } else {
          showModal('error', 'Redemption Failed', `<p>${data.error}</p>`);
        }
      } catch (error) {
        console.error('Exchange error:', error);
        showModal('error', 'System Error', '<p>An error occurred, please try again later!</p>');
      }
      
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      btn.disabled = false;
    });
  }
  
  // Load history
  async function loadHistory() {
    const tbody = document.querySelector('#acc-reward-history tbody');
    if (!tbody || !customerId) return;
    
    try {
      const response = await fetch(`${API_URL}/api/rewards/history?customer_id=${customerId}`);
      const data = await response.json();
      
      if (data.history && data.history.length > 0) {
        tbody.innerHTML = data.history.map(item => `
          <tr>
            <td data-label="Date">${new Date(item.date).toLocaleDateString('en-GB')}</td>
            <td data-label="Points">-${formatNumber(item.points_used)}</td>
            <td data-label="Code"><code>${item.discount_code}</code></td>
            <td data-label="Value">$${formatNumber(item.amount_vnd)}</td>
          </tr>
        `).join('');
        
        if (data.points !== undefined) {
          const pointsDisplay = document.getElementById('currentPointsDisplay');
          if (pointsDisplay) pointsDisplay.textContent = formatNumber(data.points);
        }
      } else {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-cell">No redemption history</td></tr>';
      }
    } catch (error) {
      console.error('Load history error:', error);
      tbody.innerHTML = '<tr><td colspan="4" class="empty-cell">Could not load history</td></tr>';
    }
  }
  
  loadHistory();
})();
</script>
